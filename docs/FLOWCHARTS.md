# 📊 流程图文档

## 1. 系统整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    系统启动流程                               │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────┐
        │  连接 MetaMask 钱包      │
        └────────────┬────────────┘
                     │
                     ▼
        ┌─────────────────────────┐
        │  初始化 FHEVM 实例      │
        └────────────┬────────────┘
                     │
                     ▼
        ┌─────────────────────────┐
        │  设置合约地址            │
        └────────────┬────────────┘
                     │
                     ▼
        ┌─────────────────────────┐
        │  加载拍卖列表            │
        └────────────┬────────────┘
                     │
                     ▼
        ┌─────────────────────────┐
        │  开始监听区块链事件      │
        └─────────────────────────┘
```

## 2. 创建拍卖流程图

```
用户操作
  │
  ▼
填写拍卖信息
  ├── 物品名称
  ├── 物品描述
  └── 持续时间
  │
  ▼
选择拍卖类型
  ├── 普通拍卖
  ├── 多轮拍卖
  └── 加权出价拍卖
  │
  ▼
前端验证
  ├── 名称长度检查
  ├── 描述长度检查
  └── 持续时间检查
  │
  ▼
调用 createAuction()
  │
  ▼
智能合约验证
  ├── 持续时间 > 0
  ├── 非紧急停止状态
  └── 创建者权限检查
  │
  ▼
创建拍卖结构
  ├── 设置创建者
  ├── 设置结束时间
  └── 初始化状态
  │
  ▼
触发 AuctionCreated 事件
  │
  ▼
前端监听事件
  │
  ▼
更新拍卖列表
  │
  ▼
显示成功通知
```

## 3. 提交出价流程图

```
用户操作
  │
  ▼
输入出价金额
  │
  ▼
检查拍卖状态
  ├── 拍卖是否进行中
  ├── 是否已过期
  └── 是否已暂停
  │
  ▼
检查用户状态
  ├── 是否已出价
  ├── 是否为创建者
  └── 是否有权限
  │
  ▼
加密出价金额
  │
  ├── 普通出价
  │     └── encryptValue()
  │
  └── 加权出价
        ├── 获取代币余额
        ├── 计算权重
        └── 加密加权出价
  │
  ▼
调用 submitBid() 或 submitWeightedBid()
  │
  ▼
智能合约验证
  ├── 拍卖状态检查
  ├── 时间检查
  ├── 出价有效性检查
  └── 重复出价检查
  │
  ▼
存储加密出价
  ├── 保存出价信息
  ├── 更新出价索引
  └── 增加出价计数
  │
  ▼
触发 BidSubmitted 事件
  │
  ▼
前端监听事件
  │
  ▼
更新出价历史
  │
  ▼
显示成功通知
  │
  ▼
滚动到出价历史区域
```

## 4. 拍卖结算流程图

```
拍卖时间到期
  │
  ▼
检查拍卖状态
  ├── 是否已结束
  ├── 是否有出价
  └── 是否已结算
  │
  ▼
调用 endAuction()
  │
  ▼
智能合约验证
  ├── 状态检查
  └── 时间检查
  │
  ▼
更新拍卖状态为 Ended
  │
  ▼
触发 AuctionEnded 事件
  │
  ▼
前端监听事件
  │
  ▼
批量获取所有出价
  │
  ▼
批量解密所有出价
  │
  ├── 使用 decryptMultiple()
  ├── 单次 EIP-712 签名
  └── 批量解密处理
  │
  ▼
比较出价（加密状态下）
  │
  ├── 使用 compareEncryptedBids()
  ├── 找出最高出价
  └── 确定获胜者
  │
  ▼
调用 setHighestBidder()
  │
  ▼
智能合约验证
  ├── 拍卖已结束
  ├── 出价索引有效
  └── 出价未揭示
  │
  ▼
设置最高出价者
  │
  ▼
触发 HighestBidderRevealed 事件
  │
  ▼
调用 finalizeAuction()
  │
  ▼
智能合约验证
  ├── 拍卖已结束
  ├── 有获胜者
  └── 未结算
  │
  ▼
更新拍卖状态为 Finalized
  │
  ▼
触发 AuctionFinalized 事件
  │
  ▼
前端监听事件
  │
  ▼
显示获胜者信息
  │
  ▼
更新拍卖列表
```

## 5. 多轮拍卖流程图

```
第一轮拍卖结束
  │
  ▼
检查是否为多轮拍卖
  │
  ▼
调用 finalizeAuction()
  │
  ▼
第一轮结算完成
  │
  ▼
创建者创建下一轮
  │
  ▼
调用 createNextRound()
  │
  ▼
智能合约验证
  ├── 是否为多轮拍卖
  ├── 是否为创建者
  ├── 父拍卖已结算
  └── 持续时间 > 0
  │
  ▼
创建新拍卖
  ├── 继承父拍卖信息
  ├── 设置新轮次
  └── 初始化状态
  │
  ▼
更新轮次映射
  │
  ▼
触发 MultiRoundAuctionCreated 事件
  │
  ▼
前端监听事件
  │
  ▼
更新拍卖列表
  │
  ▼
显示新轮次通知
```

## 6. 加权出价流程图

```
用户选择加权出价
  │
  ▼
检查代币地址是否设置
  │
  ▼
获取用户代币余额
  │
  ├── 调用 ERC20 balanceOf()
  └── 计算权重
  │
  ▼
用户输入出价金额
  │
  ▼
计算加权出价
  │
  ├── 权重系数 = sqrt(余额 / 1000)
  └── 加权出价 = 原始出价 × 权重系数
  │
  ▼
加密加权出价
  │
  ▼
调用 submitWeightedBid()
  │
  ▼
智能合约验证
  ├── 加权出价已启用
  ├── 代币余额 > 0
  └── 其他常规检查
  │
  ▼
存储加权出价
  ├── 保存加密出价
  ├── 保存权重
  └── 更新索引
  │
  ▼
触发 WeightedBidSubmitted 事件
  │
  ▼
前端监听事件
  │
  ▼
显示加权出价信息
```

## 7. 紧急停止流程图

```
检测到异常情况
  │
  ▼
选择停止类型
  │
  ├── 单个拍卖暂停
  │     └── pauseAuction()
  │
  └── 全局紧急停止
        └── emergencyPauseAll()
  │
  ▼
智能合约验证
  ├── 创建者权限（单个）
  └── 管理员权限（全局）
  │
  ▼
更新暂停状态
  │
  ▼
触发暂停事件
  │
  ├── AuctionPaused
  └── EmergencyPause
  │
  ▼
阻止新操作
  ├── 阻止新出价
  ├── 阻止新拍卖
  └── 显示暂停提示
  │
  ▼
问题解决后
  │
  ▼
调用恢复函数
  │
  ├── unpauseAuction()
  └── emergencyUnpauseAll()
  │
  ▼
更新恢复状态
  │
  ▼
触发恢复事件
  │
  ├── AuctionUnpaused
  └── EmergencyUnpause
  │
  ▼
恢复正常操作
```

## 8. 事件监听流程图

```
系统启动
  │
  ▼
初始化事件监听器
  │
  ├── 连接合约实例
  ├── 设置事件过滤器
  └── 注册事件处理器
  │
  ▼
开始监听
  │
  ├── AuctionCreated
  ├── BidSubmitted
  ├── AuctionEnded
  ├── AuctionFinalized
  └── 其他事件
  │
  ▼
事件触发
  │
  ▼
事件处理器
  │
  ├── 解析事件数据
  ├── 更新本地状态
  ├── 触发通知
  └── 更新 UI
  │
  ▼
错误处理
  │
  ├── 连接断开
  ├── 自动重连
  └── 错误通知
  │
  ▼
清理资源
  │
  └── 移除事件监听器
```

## 9. 批量解密流程图

```
拍卖结束
  │
  ▼
获取所有出价
  │
  ├── 调用 getBidsBatch()
  └── 获取加密出价数组
  │
  ▼
准备批量解密
  │
  ├── 获取 FHEVM 实例
  ├── 获取解密权限
  └── 准备 EIP-712 签名
  │
  ▼
单次签名
  │
  ├── signTypedData()
  └── 获取签名
  │
  ▼
批量解密循环
  │
  ├── 遍历加密出价
  ├── 使用同一签名解密
  └── 收集解密结果
  │
  ▼
错误处理
  │
  ├── 单个解密失败
  ├── 使用默认值
  └── 继续处理
  │
  ▼
返回解密结果数组
  │
  ▼
更新 UI
  │
  ├── 显示解密后的出价
  ├── 更新统计信息
  └── 更新图表
```

## 10. 数据可视化流程图

```
用户打开数据分析
  │
  ▼
检查数据可用性
  │
  ├── 是否有出价
  └── 拍卖是否结束
  │
  ▼
选择图表类型
  │
  ├── 趋势图
  ├── 分布图
  └── 时间线
  │
  ▼
加载数据
  │
  ├── 获取出价列表
  ├── 批量解密（如果已结束）
  └── 处理时间戳
  │
  ▼
计算统计数据
  │
  ├── 平均值
  ├── 中位数
  ├── 标准差
  └── 分布区间
  │
  ▼
绘制图表
  │
  ├── 使用 Canvas API
  ├── 响应式布局
  └── 交互式元素
  │
  ▼
显示图表
  │
  ├── 实时更新
  └── 用户交互
```

## 11. 实时通知流程图

```
系统启动
  │
  ▼
初始化通知系统
  │
  ├── 创建通知队列
  ├── 设置通知历史
  └── 配置通知选项
  │
  ▼
开始监听事件
  │
  ├── 连接事件监听器
  └── 注册事件处理器
  │
  ▼
事件触发
  │
  ▼
检查通知条件
  │
  ├── 用户相关事件
  ├── 重要状态变化
  └── 用户设置偏好
  │
  ▼
创建通知
  │
  ├── 生成通知 ID
  ├── 设置通知类型
  ├── 设置通知消息
  └── 记录时间戳
  │
  ▼
添加到通知队列
  │
  ▼
显示通知
  │
  ├── 浏览器通知（如果允许）
  ├── UI 通知组件
  └── 声音提示（可选）
  │
  ▼
用户交互
  │
  ├── 查看通知
  ├── 标记已读
  └── 删除通知
  │
  ▼
自动清理
  │
  └── 删除过期通知（7天）
```

## 12. 移动端优化流程图

```
用户访问网站
  │
  ▼
检测设备类型
  │
  ├── 移动设备
  ├── 平板设备
  └── 桌面设备
  │
  ▼
加载响应式布局
  │
  ├── 移动端布局
  ├── 平板端布局
  └── 桌面端布局
  │
  ▼
优化交互
  │
  ├── 触摸优化
  ├── 手势支持
  └── 按钮大小调整
  │
  ▼
性能优化
  │
  ├── 懒加载
  ├── 代码分割
  └── 图片优化
  │
  ▼
适配显示
  │
  ├── 字体大小
  ├── 间距调整
  └── 颜色对比度
```


