# 🏗️ 系统架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层 (UI Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  拍卖列表    │  │  拍卖详情    │  │  数据分析    │         │
│  │  Component   │  │  Component   │  │  Component   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  创建拍卖    │  │  数据可视化  │  │  实时通知    │         │
│  │  Component   │  │  Component   │  │  Component   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     业务逻辑层 (Business Layer)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  FHEVM工具   │  │  合约交互    │  │  统计分析    │         │
│  │  加密/解密   │  │  交易处理    │  │  数据聚合    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  事件监听    │  │  批量操作    │  │  加权计算    │         │
│  │  Hook        │  │  工具函数    │  │  工具函数    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FHEVM SDK 层 (FHEVM Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  EIP-712     │  │  批量解密    │  │  公共解密    │         │
│  │  签名解密    │  │  decryptMultiple│  Public Decrypt│         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  加密比较    │  │  事件驱动    │  │  加密存储    │         │
│  │  Comparison  │  │  Decryption │  │  Storage     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   智能合约层 (Smart Contract Layer)               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              SealedBidAuction.sol                        │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │   │
│  │  │ 拍卖管理   │  │ 出价管理   │  │ 结算管理   │        │   │
│  │  │ createAuction│ submitBid   │ finalizeAuction│        │   │
│  │  └────────────┘  └────────────┘  └────────────┘        │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │   │
│  │  │ 多轮拍卖   │  │ 加权出价   │  │ 紧急停止   │        │   │
│  │  │ createNextRound│ submitWeightedBid│ pauseAuction│        │   │
│  │  └────────────┘  └────────────┘  └────────────┘        │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   区块链网络层 (Blockchain Layer)                 │
│                      Sepolia 测试网                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  事件日志    │  │  状态存储    │  │  交易执行    │         │
│  │  Event Logs  │  │  State Storage│  │  Transaction │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流程图

### 1. 创建拍卖流程

```
用户输入
  │
  ▼
创建拍卖表单
  │
  ▼
加密物品信息（可选）
  │
  ▼
调用 createAuction()
  │
  ▼
智能合约创建拍卖
  │
  ▼
触发 AuctionCreated 事件
  │
  ▼
前端监听事件
  │
  ▼
更新拍卖列表
  │
  ▼
显示成功通知
```

### 2. 提交出价流程

```
用户输入出价金额
  │
  ▼
使用 FHEVM 加密出价
  │
  ▼
计算权重（如果启用加权出价）
  │
  ▼
调用 submitBid() 或 submitWeightedBid()
  │
  ▼
智能合约存储加密出价
  │
  ▼
触发 BidSubmitted 事件
  │
  ▼
前端监听事件
  │
  ▼
更新出价历史
  │
  ▼
显示成功通知
```

### 3. 拍卖结算流程

```
拍卖时间到期
  │
  ▼
调用 endAuction()
  │
  ▼
触发 AuctionEnded 事件
  │
  ▼
前端监听事件
  │
  ▼
批量解密所有出价
  │
  ▼
比较出价（加密状态下）
  │
  ▼
调用 setHighestBidder()
  │
  ▼
调用 finalizeAuction()
  │
  ▼
触发 AuctionFinalized 事件
  │
  ▼
显示获胜者信息
```

### 4. 加密比较流程（未来实现）

```
获取两个加密出价
  │
  ▼
调用 FHEVM 预编译合约
  │
  ▼
在加密状态下比较
  │
  ▼
返回加密的比较结果
  │
  ▼
解密比较结果
  │
  ▼
确定最高出价
```

## 技术栈架构

### 前端架构

```
Next.js 14 (App Router)
  │
  ├── React 18
  │     ├── Hooks (useState, useEffect, useCallback)
  │     ├── Context API (状态管理)
  │     └── Custom Hooks (业务逻辑封装)
  │
  ├── Tailwind CSS
  │     ├── 响应式设计
  │     ├── 暗色模式支持
  │     └── 动画效果
  │
  ├── Ethers.js
  │     ├── 钱包连接
  │     ├── 合约交互
  │     └── 事件监听
  │
  └── FHEVM SDK
        ├── 加密/解密
        ├── EIP-712 签名
        └── 批量操作
```

### 智能合约架构

```
SealedBidAuction.sol
  │
  ├── 核心功能
  │     ├── 拍卖管理
  │     ├── 出价管理
  │     └── 结算管理
  │
  ├── 高级功能
  │     ├── 多轮拍卖
  │     ├── 加权出价
  │     └── 紧急停止
  │
  ├── 数据存储
  │     ├── 拍卖映射
  │     ├── 出价映射
  │     └── 状态映射
  │
  └── 事件系统
        ├── AuctionCreated
        ├── BidSubmitted
        ├── AuctionEnded
        └── AuctionFinalized
```

## 安全架构

### 加密层

```
用户出价
  │
  ▼
FHEVM 加密
  │
  ▼
加密数据存储到链上
  │
  ▼
拍卖结束前保持加密
  │
  ▼
EIP-712 签名解密
  │
  ▼
显示解密结果
```

### 访问控制层

```
用户操作
  │
  ▼
检查权限
  │
  ├── 创建者权限
  │     ├── 提前结束拍卖
  │     ├── 结算拍卖
  │     └── 暂停拍卖
  │
  ├── 出价者权限
  │     ├── 提交出价
  │     ├── 修改出价
  │     └── 撤回出价
  │
  └── 查看者权限
        └── 查看拍卖信息
```

## 性能优化架构

### 批量操作优化

```
传统方式（逐个操作）
  操作1 → 操作2 → 操作3 → ... → 操作N
  总时间 = N × 单次操作时间

批量操作优化
  批量操作 → 单次签名 → 批量处理
  总时间 = 单次操作时间 + 批量处理时间
```

### 事件监听优化

```
传统方式（轮询）
  定时查询 → 检查状态 → 更新UI
  延迟高，资源消耗大

事件驱动方式
  监听事件 → 实时更新 → 推送通知
  延迟低，资源消耗小
```

## 扩展性架构

### 模块化设计

```
核心模块
  ├── 拍卖管理
  ├── 出价管理
  └── 结算管理

扩展模块
  ├── 多轮拍卖
  ├── 加权出价
  ├── 数据分析
  └── 通知系统
```

### 插件化架构

```
基础合约
  │
  ├── 插件接口
  │     ├── IWeightedBidding
  │     ├── IMultiRound
  │     └── IAnalytics
  │
  └── 实现合约
        ├── WeightedBiddingPlugin
        ├── MultiRoundPlugin
        └── AnalyticsPlugin
```

## 部署架构

### 开发环境

```
本地开发
  ├── Hardhat 本地网络
  ├── FHEVM 本地节点
  └── Next.js 开发服务器
```

### 测试环境

```
Sepolia 测试网
  ├── 合约部署
  ├── 前端部署（Vercel）
  └── 集成测试
```

### 生产环境

```
主网部署
  ├── 合约审计
  ├── 安全测试
  └── 渐进式发布
```

## 监控架构

### 事件监控

```
区块链事件
  │
  ▼
事件监听器
  │
  ▼
事件处理器
  │
  ├── 通知系统
  ├── 数据分析
  └── 日志记录
```

### 性能监控

```
前端性能
  ├── 页面加载时间
  ├── 交互响应时间
  └── 错误率

合约性能
  ├── Gas 消耗
  ├── 交易成功率
  └── 事件处理时间
```


